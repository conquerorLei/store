### 1 密码修改

#### 1.1  持久层

##### 1.1.1  规划需要执行的SQL语句

根据用户的uid修改用password值。

```sql
update user set password = ?, modified_user = ?, modified_time = ? where uid = ?;
```

根据uid查询用户的数据。在修改密码之前，首先要保证当前这用户的数据存在，检测是否被标记为已经删除、检测输入的原始密码是否正确。

```sql
select * from t_user where uid = ?;
```

##### 1.1.2 设计接口和抽象方法

在UserMapper接口中添加方法

```java
	/**
     * @author LiXianLei
     * @describtion 修改密码
     * @return {@link Integer} 影响的行数
     * @param uid 用户编号
     * @param password 修改后的密码
     * @param modifiedUser 修改人
     * @param modifiedTime 修改时间
     * @time 2022/1/13 21:07
     **/
    Integer updatePassword(Integer uid, String password, String modifiedUser, Date modifiedTime);

    /**
     * @author LiXianLei
     * @describtion 根据用户id查询用户
     * @return {@link User} 用户
     * @param uid 用户编号
     * @time 2022/1/13 21:08
     **/
    User findByUid(Integer uid);
```

##### 1.1.3 编写映射

在UserMapper.xml文件中实现这个方法

```xml
<update id="updatePassword">
    update t_user
    set password = #{password},
    modified_user = #{modifiedUser},
    modified_time = #{modifiedTime}
    where uid = #{uid}
</update>
<select id="findByUid" resultMap="UserEntityMap">
    select * from t_user where uid = #{uid}
</select>
```

##### 1.1.4 测试接口是否可用

```java
@Test
public void updatePassword(){
    String password = "123456";
    Date date = new Date();
    Integer rows = userMapper.updatePasswordByUid(1, password, "管理员", date);
    if(rows == 1) System.out.println("密码已经修改");
    else System.out.println("发生未知错误");
}
@Test
public void findByUid(){
    User user = userMapper.findByUid(1);
    System.out.println(user);
}
```

![密码测试持久层提交记录](https://gitee.com/QingShanxl/pictures/raw/master/img//image-20220113205631830.png)

#### 1.2 业务层

##### 1.2.1 规划异常

1. 用户不存在，或者已经被删除
2. 用户原密码不正确
3. 另外就是执行数据库更新操作的时候可能会出现异常：UpdateException

##### 1.2.2 设计接口和实现抽象方法

```java
	/**
     * @author LiXianLei
     * @describtion 更新用户密码
     * @return 没有返回值
     * @param uid 用户编号
     * @param username 用户名称
     * @param oldPassword 原密码
     * @param newPassword 新密码
     * @time 2022/1/14 11:21
     **/
    void changePassword(Integer uid, String username, String oldPassword, String newPassword);
```

1.2.3 测试

#### 1.3 控制层

##### 1.3.1 处理异常

处理新增异常UpdateException

##### 1.3.2 设计请求

```
/users/change_password
POST
String oldPassword,String newPassword, HttpSession session
JsonResult<Void>
```

##### 1.3.3 实现请求

```java
@RequestMapping("change_password")
public JsonResult<Void> changePassword(String oldPassword, String newPassword, HttpSession session){
    Integer uid = getUidFromSession(session);
    String username = getUsernameFromSession(session);
    userService.changePassword(uid, username, oldPassword, newPassword);
    return new JsonResult<>(OK, "修改成功");
}
```

测试

![测试接口](https://gitee.com/QingShanxl/pictures/raw/master/img/gpLZuo561jkmhdG.png)

#### 1.4 前端页面

直接添加ajax请求就好

```javascript
$("#btn-change-password").click(function(){
    $.ajax({
        url: "/users/change_password",
        type: "POST",
        data: $("#form-change-password").serialize(),
        dataType: "JSON",
        success: function(json){
            if(json.state == 200){
                alert("修改成功，请使用新密码登录");
                location.href="login.html";
            }else{
                alert(json.message);
            }
        },
        error: function(xhr){
            alert("修改密码产生未知错误" + xhr.status);
        }
    });
});
```

### 2 个人资料修改

#### 2.1 持久层

##### 2.1.1 规划需要执行的SQL语句

1. 根据已经登录的用户ID查询当前用户是否存在

   ```sql
   select * from t_user where uid = ?
   ```

2. 对数据库中的对应字段进行更新操作

   ```sql
   update t_user
   set phone = ?,
   	email = ?,
   	gender = ?,
   	modified_user = ?,
   	modified_time = ?
   where uid = ?
   ```

##### 2.1.2 设计接口

在UserMapper中编写上述需要执行的SQL语句对应的接口

##### 2.1.3 编写映射

##### 2.1.4 测试

